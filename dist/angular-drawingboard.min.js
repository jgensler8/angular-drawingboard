/* angular-drawingboard v0.1.0 - https://github.com/Leimi/drawingboard.js
* Copyright (c) 2014 Jeffrey Gensler
* Licensed MIT */
!function(){angular.module("ng-drawingboard",["ngStorage"]).directive("ngDrawingboard",["$sessionStorage","$localStorage",function(a,b){var c=0,d={toDataURL:function(a,b){return a.canvas.toDataURL(b)},initStorage:function(d,e){var f=d.canvas.id||"tempID";"session"===e?a[f]?(this.setIMG(d,a[f][a[f].length-1]),c=a[f].length-1):(a[f]=[],this.save(d,e)):"local"===e&&(b[f]?(this.setIMG(d,b[f][b[f].length-1]),c=b[f].length-1):(b[f]=[],this.save(d,e)))},save:function(d,e){var f=d.canvas.id||"tempID";"session"===e?(c<a[f].length&&a[f].splice(c+1,a[f].length-c),c=a[f].length,a[f].push(this.toDataURL(d,"image/png"))):"local"===e&&(c<b[f].length&&b[f].splice(c+1,b[f].length-c),c=b[f].length,b[f].push(this.toDataURL(d,"image/png")))},undo:function(d,e){if(0>=c)return!1;var f=d.canvas.id||"tempID";return"session"===e?(--c,this.setIMG(d,a[f][c])):"local"===e&&(--c,this.setIMG(d,b[f][c])),!0},redo:function(d,e){var f=d.canvas.id||"tempID";if("session"===e){if(c+1>=a[f].length)return!1;console.log("increasing"),++c,this.setIMG(d,a[f][c])}else if("local"===e){if(c+1>=b[f].length)return!1;++c,this.setIMG(d,b[f][c])}return!0},clearStorage:function(c,d){var e=c.canvas.id||"tempID";return"session"===d?a[e]=void 0:"local"===d&&(b[e]=void 0),this.initStorage(c,d)},initBackground:function(a,b,c,d,e){a.canvas.width="parent"===c?e.offsetWidth:c||300,a.canvas.height="parent"===d?e.offsetWidth:d||150,a.fillStyle=b,a.fillRect(0,0,a.canvas.width,a.canvas.height)},initDrawingStyle:function(a,b){a.lineWidth=b,a.lineJoin=a.lineCap="round"},draw:function(a,b,c,d,e,f,g){a.beginPath(),a.moveTo(f,g),a.quadraticCurveTo(b,c,d,e),a.stroke()},fill:function(a,b){function c(a){d.data[a[e]]=j,d.data[a[e]+1]=k,d.data[a[e]+2]=l}var d=a.getImageData(0,0,a.canvas.width,a.canvas.height),e=0,f=1,g=2,h=3,i=a.strokeStyle,j=parseInt(i.substr(1,2),16),k=parseInt(i.substr(3,2),16),l=parseInt(i.substr(5,2),16),m=this._pixelAt(d,parseInt(b.x,10),parseInt(b.y,10)),n=m[h];if(this._compareColors(n,this._RGBToInt(j,k,l)))return!1;for(var o,p=[m],q=d.width-1,r=d.height-1;o=p.pop();)c(o),this._compareColors(o[h],n)&&(o[f]>0&&p.push(this._pixelAt(d,o[f]-1,o[g])),o[f]<q&&p.push(this._pixelAt(d,o[f]+1,o[g])),o[g]>0&&p.push(this._pixelAt(d,o[f],o[g]-1)),o[g]<r&&p.push(this._pixelAt(d,o[f],o[g]+1)));return a.putImageData(d,0,0),!0},clear:function(a,b,c,e,f){d.initBackground(a,b,c,e,f)},setIMG:function(a,b){var c=new Image,d=a.globalCompositeOperation;c.onload=function(){a.globalCompositeOperation="source-over",a.clearRect(0,0,a.canvas.width,a.canvas.height),a.drawImage(c,0,0),a.globalCompositeOperation=d},c.src=b},_getInputCoords:function(a,b){a=a.originalEvent?a.originalEvent:a;var c,d;return a.touches&&1==a.touches.length?(c=a.touches[0].pageX,d=a.touches[0].pageY):(c=a.pageX,d=a.pageY),{x:c-b.canvas.offsetLeft,y:d-b.canvas.offsetTop}},_getMidCoords:function(a,b,c,d){return{x:a+c>>1,y:b+d>>1}},_getStorage:function(){return!this.opts.webStorage||"session"!==this.opts.webStorage&&"local"!==this.opts.webStorage?!1:this.opts.webStorage+"Storage"},_pixelAt:function(a,b,c){var d=4*(c*a.width+b),e=this._RGBToInt(a.data[d],a.data[d+1],a);return[d,b,c,e]},_compareColors:function(a,b){return a===b},_RGBToInt:function(a,b,c){var d=0;return d|=(255&a)<<16,d|=(255&b)<<8,d|=255&c}};return{template:"<canvas />",transclude:!0,restrict:"E",scope:{remote:"=remote",webStorage:"=webstorage",drawingMode:"=drawingmode",drawColor:"=drawcolor",eraseColor:"=erasecolor",lineWidth:"=linewidth",backgroundColor:"=backgroundcolor",canvasWidth:"=canvaswidth",canvasHeight:"=canvasheight"},link:function(a,b){a.canvas=b[0].firstChild,a.context=a.canvas.getContext("2d"),a.oldMidX=0,a.oldMidY=0,a.oldX=0,a.oldY=0,d.initBackground(a.context,a.backgroundColor,a.canvasWidth,a.canvasHeight,b.parent()[0]),d.initDrawingStyle(a.context,a.lineWidth),d.initStorage(a.context,a.webStorage),a.remote=angular.extend({toDataURL:function(b){return d.toDataURL(a.context,b)},clear:function(){return d.clear(a.context,a.backgroundColor,a.canvasWidth,a.canvasHeight,b.parent()[0]),d.save(a.context,a.webStorage)},clearStorage:function(){return d.clearStorage(a.context,a.webStorage)},undo:function(){return d.undo(a.context,a.webStorage)},redo:function(){return d.redo(a.context,a.webStorage)},startDraw:function(){},endDraw:function(){},drawing:function(){},startErase:function(){},endErase:function(){},erasing:function(){},fill:function(){}},a.remote),a.$watch("lineWidth",function(b){a.context.lineWidth=b}),b.bind("mousedown touchstart",function(b){a.drawing=!0;var c=d._getInputCoords(b,a.context);a.oldX=a.oldMidX=c.x,a.oldY=a.oldMidY=c.y,"draw"===a.drawingMode?(a.context.strokeStyle=a.drawColor,a.remote.startDraw(b)):"fill"===a.drawingMode?(a.context.strokeStyle=a.drawColor,d.fill(a.context,c),a.remote.fill(b)):"eraser"===a.drawingMode&&(a.context.strokeStyle=a.eraseColor,a.remote.startErase(b))}),b.bind("mouseup touchend",function(b){a.drawing=!1,a.webStorage&&d.save(a.context,a.webStorage),"draw"===a.drawingMode?a.remote.endDraw(b):"eraser"===a.drawingMode&&a.remote.endErase(b)}),b.bind("mousemove touchmove",function(b){var c=d._getInputCoords(b,a.context),e=d._getMidCoords(a.oldX,a.oldY,c.x,c.y);a.drawing===!0&&(d.draw(a.context,a.oldX,a.oldY,a.oldMidX,a.oldMidY,e.x,e.y),"draw"===a.drawingMode?a.remote.drawing(b):"eraser"===a.drawingMode&&a.remote.erasing(b)),a.oldX=c.x,a.oldY=c.y,a.oldMidX=e.x,a.oldMidY=e.y}),b.bind("mouseleave",function(b){a.drawing===!0&&(a.drawing=!1,a.webStorage&&d.save(a.context,a.webStorage),"draw"===a.drawingMode?a.remote.endDraw(b):"eraser"===a.drawingMode&&a.remote.endErase(b))})}}}])}();