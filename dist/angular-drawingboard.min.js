/* angular-drawingboard v0.1.0 - https://github.com/Leimi/drawingboard.js
* Copyright (c) 2014 Jeffrey Gensler
* Licensed MIT */
!function(){angular.module("ng-drawingboard",["ngStorage"]).directive("ngDrawingboard",["$sessionStorage","$localStorage",function(a,b){var c=0,d={toDataURL:function(a,b){return a.toDataURL(b)},initStorage:function(c,d){var e=c.id||"tempID";a[e]=[],b[e]=[],"session"===d?this.save(c,d):"local"===d&&this.save(c,d)},save:function(d,e){var f=d.id||"tempID";"session"===e?(c<a[f].length&&a[f].slice(c+1,a[f].length),c=a[f].length,a[f].push(this.toDataURL(d,"image/png")),++c):"local"===e&&(c<b[f].length&&b[f].slice(c+1,b[f].length),c=b[f].length,b[f].push(this.toDataURL(d,"image/png")),++c)},undo:function(d,e,f){if(!(0>=c)){var g=d.id||"tempID";"session"===f?(--c,this.setIMG(d,e,a[g][c])):"local"===f&&(--c,this.setIMG(d,e,b[g][c]))}},redo:function(d,e,f){var g=d.id||"tempID";if("session"===f){if(c>=a[g].length)return;--c,this.setIMG(d,e,a[g][c])}else if("local"===f){if(c>=b[g].length)return;--c,this.setIMG(d,e,b[g][c])}},clearStorage:function(c,d){"session"===d?a.$reset():"local"===d&&b.$reset()},initDrawingStyle:function(a,b){a.lineWidth=b},draw:function(a,b,c,d,e,f,g,h,i){a.beginPath(),a.moveTo(h,i),a.quadraticCurveTo(b,c,d,e),a.stroke()},fill:function(){},clear:function(a){a.clearRect(0,0,a.canvas.width,a.canvas.width)},setIMG:function(a,b,c){var d=new Image,e=b.globalCompositeOperation;d.onload=function(){b.globalCompositeOperation="source-over",b.clearRect(0,0,a.width,a.height),b.drawImage(d,0,0),b.globalCompositeOperation=e},d.src=c},_getInputCoords:function(a,b){a=a.originalEvent?a.originalEvent:a;var c,d;return a.touches&&1==a.touches.length?(c=a.touches[0].pageX,d=a.touches[0].pageY):(c=a.pageX,d=a.pageY),{x:c-b.canvas.offsetLeft,y:d-b.canvas.offsetTop}},_getMidCoords:function(a,b,c,d){return{x:a+c>>1,y:b+d>>1}},_getStorage:function(){return!this.opts.webStorage||"session"!==this.opts.webStorage&&"local"!==this.opts.webStorage?!1:this.opts.webStorage+"Storage"}};return{template:"<canvas />",transclude:!0,restrict:"E",scope:{remote:"=remote",webStorage:"=webstorage",drawingMode:"=drawingmode",drawColor:"=drawcolor",eraseColor:"=erasecolor",lineWidth:"=linewidth"},link:function(a,b){a.canvas=b[0].firstChild,a.context=a.canvas.getContext("2d"),a.oldMidX=0,a.oldMidY=0,a.oldX=0,a.oldY=0,d.initStorage(a.canvas,a.webStorage),d.initDrawingStyle(a.context,a.lineWidth),a.remote=angular.extend({toDataURL:function(b){return d.toDataURL(a.canvas,b)},clear:function(){return d.clear(a.context)},clearStorage:function(){return d.clearStorage()},undo:function(){return d.undo(a.canvas,a.context,a.webStorage)},redo:function(){return d.redo(a.canvas,a.context,a.webStorage)},startDraw:function(){},endDraw:function(){},drawing:function(){},startErase:function(){},endErase:function(){},erasing:function(){},fill:function(){}},a.remote),a.$watch("lineWidth",function(b){a.context.lineWidth=b}),b.bind("mousedown touchstart",function(b){if(a.drawing=!0,"draw"===a.drawingMode)a.context.strokeStyle=a.drawColor,a.remote.startDraw(b);else if("fill"===a.drawingMode){var c=d._getInputCoords(b,a.context);d.fill(context,c),a.remote.fill(b)}else"eraser"===a.drawingMode&&(a.context.strokeStyle=a.eraseColor,a.remote.startErase(b))}),b.bind("mouseup touchend",function(b){a.drawing=!1,a.webStorage&&d.save(a.canvas,a.webStorage),"draw"===a.drawingMode?a.remote.endDraw(b):"eraser"===a.drawingMode&&a.remote.endErase(b)}),b.bind("mousemove touchmove",function(b){var c=d._getInputCoords(b,a.context),e=d._getMidCoords(a.oldX,a.oldY,c.x,c.y);a.drawing===!0&&(d.draw(a.context,a.oldX,a.oldY,a.oldMidX,a.oldMidY,c.x,c.y,e.x,e.y),"draw"===a.drawingMode?a.remote.drawing(b):"eraser"===a.drawingMode&&a.remote.erasing(b)),a.oldX=c.x,a.oldY=c.y,a.oldMidX=e.x,a.oldMidY=e.y}),b.bind("mouseleave",function(b){a.drawing===!0&&(a.drawing=!1,a.webStorage&&d.save(a.canvas,a.webStorage),"draw"===a.drawingMode?(a.remote.endDraw(b),a.drawing=!1):"eraser"===a.drawingMode&&(a.remote.endErase(b),a.drawing=!1))})}}}])}();